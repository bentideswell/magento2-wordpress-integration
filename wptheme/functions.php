<?php
/**
 *
 * DO NOT EDIT THIS FILE
 * Any changes you make to this file will be lost
 * To customise things, create a file at wp-content/themes/fishpig/local.php
 * This file will not be deleted or overwritten and is automatically included at the end of this file
 *
 */
// phpcs:ignoreFile -- this file is a WordPress theme file and will not run in Magento

/**
 *
 */
define('FISHPIG_THEME_HASH', '{REMOTE_HASH}');

/**
 *
 */
add_action('init', function() {
    add_rewrite_rule('^wordpress/post/preview/?$', 'index.php', 'top');
    
    // We have Yoast so lets disable some redirects
    if (isset($GLOBALS['wpseo_rewrite'])) {
        remove_filter('request', array($GLOBALS['wpseo_rewrite'], 'request'));
    }
});

/**
 *
 */
add_action('after_setup_theme', function() {
    add_theme_support('title-tag');
    add_theme_support('post-thumbnails');
    set_post_thumbnail_size(9999, 9999);

    add_theme_support('post-formats', array('aside', 'image', 'video', 'quote', 'link', 'gallery', 'status', 'audio', 'chat'));

    if (function_exists('show_admin_bar')) {
        show_admin_bar(false);
    }

    /* Remove the Emoji JS */
    remove_action( 'wp_head', 'print_emoji_detection_script', 7 ); 
    remove_action( 'admin_print_scripts', 'print_emoji_detection_script' ); 
    remove_action( 'wp_print_styles', 'print_emoji_styles' ); 
    remove_action( 'admin_print_styles', 'print_emoji_styles' );
    remove_filter('template_redirect', 'redirect_canonical');
    remove_action('template_redirect', 'wp_old_slug_redirect');

    /* Remove wptexturize to fix shortcodes */
    remove_filter('the_content', 'wptexturize');
});

/**
 *
 */
add_action('wp_loaded', function() {
    if ($post_types = get_post_types(array('public' => true, '_builtin' => false))) {
        foreach ($post_types as $post_type) {
            add_filter(
                "theme_{$post_type}_templates", 
                function($page_templates, $wp_theme, $post) {
                    return [
                        'template-empty' => 'Empty',
                        'template-1column' => '1 Column',
                        'template-2columns-left' => '2 Columns Left',
                        'template-2columns-right' => '2 Columns Right',
                        'template-3columns' => '3 Columns',        
                        'template-full-width' => 'Full Width',
                    ] + $page_templates;
                }, 
                10, 
                4
            );
        }
    }
});

/**
 *
 */
add_action('widgets_init', function() {
    register_sidebar([
        'name' => __( 'Main Sidebar', 'fishpig' ),
        'id' => 'sidebar-main',
        'description' => 'Add widgets here to appear in your left Magento sidebar.',
        'before_widget' => '<aside id="%1$s" class="widget %2$s">',
        'after_widget' => '</aside>',
        'before_title' => '<h2 class="widget-title">',
        'after_title' => '</h2>',
    ]);

    global $wp_widget_factory;

    remove_action('wp_head', array($wp_widget_factory->widgets['WP_Widget_Recent_Comments'], 'recent_comments_style'));
});

/**
 *
 */
add_filter('redirect_canonical', function($redirect_url){
    return is_404() ? false : $redirect_url;
});

/**
 *
 */
add_filter('preview_post_link', function($previewLink, $post){
    $postPermalink = get_the_permalink($post);

    if ($postPermalink && strpos($previewLink, $postPermalink) !== 0) {
        if ($pageForPostsUrl = fishpig_get_page_for_posts_url()) {       
            $queryString = substr($previewLink, strpos($previewLink, '?'));
            $previewLink = $pageForPostsUrl . $queryString;
        }
    }

    return $previewLink . '&fishpig=' . time();
});

/**
 *
 */
function fishpig_get_page_for_posts_url()
{
    if ($pageForPostsId = (int)get_option('page_for_posts')) {
        return get_permalink($pageForPostsId);
    } 

    return false;
}
    
/**
 *
 */
function fishpig_on_post_page_link($postLink)
{
    if (strpos($postLink, 'page_id=') === false && strpos($postLink, '?p=') === false) {
        return $postLink;
    }

    $homeUrl = rtrim(get_option('home'), '/') . '/';
    $queryString = substr($postLink, strpos($postLink, '?'));
    $postLink = $homeUrl . $queryString;

    return $postLink . '&fishpig=' . time() . '&preview=true';
}


/**
 *
 */
add_filter('page_link', 'fishpig_on_post_page_link');
add_filter('post_link', 'fishpig_on_post_page_link');
add_filter('vcv:frontend:pageEditable:url', 'fishpig_on_post_page_link');

/**
 *
 */
add_filter('rest_url', function($rest){
    $find   = '/wp-json/';
    $pos    = strpos($rest, $find);
    $extra  = '';

    if ($pos !== false && strlen($rest) > $pos+strlen($find)) {
        $extra = substr($rest, $pos+strlen($find));
    }

    return get_option('siteurl') . '/index.php?rest_route=/' . ltrim($extra, '/');
});

/**
 *
 */
add_filter('status_header', function($status_header, $code, $description, $protocol){
    if ((int)$code === 404) {
        return '';
    }

    return $status_header;
}, 10, 4);

/**
 *
 */
add_filter('wp_headers', function($headers){
      if (isset($headers['Content-Type']) && strpos($headers['Content-Type'], 'text/html') !== false) {
        unset($headers['Content-Type']);
    }

    return $headers;
}, 10, 4);

/**
 *
 */
add_action('wp_footer',function(){
    wp_deregister_script('wp-embed');

    // Divi
    if (isset($_GET['et_fb'])) {
        wp_dequeue_style('wp-auth-check');
        wp_dequeue_script('wp-auth-check');
        remove_action('wp_print_footer_scripts', 'et_fb_output_wp_auth_check_html', 5);
    }
}, 12);

/**
 *
 */
add_action('save_post', function($post_id) {
    try {
        $post = get_post($post_id);
        $content = apply_filters('the_content', $post->post_content);

        if (!empty($GLOBALS['wp_embed'])) {
            $content = $GLOBALS['wp_embed']->autoembed($content);
        }

        // Auto include the related products shortcode
        if (class_exists('FishPig_RelatedProducts')) {
            if ((int)get_option('fprp_autoinclude', 1) === 1) {
                $content .= '[related_products]';
            }
        }

        update_post_meta($post_id, '_post_content_rendered', $content);
    } catch (\Exception $e) {
        // Do nothing
    }
});

/**
 *
 */
add_action('admin_menu',function() {
    global $submenu;

    if (isset($submenu['themes.php'])) {
        foreach ($submenu['themes.php'] as $it => $menuItem ) {
            if (in_array('Customize', $menuItem) || in_array('Customizer', $menuItem)) {
                unset($submenu['themes.php'][$it]);
            }
        }
    }
});

/**
 *
 */
add_filter('vc_front_render_shortcodes', function($content) {
    return '<!--FP-the_content-->' . $content . '<!--/FP-the_content-->';
}, 99999);
/**
 *
 */
add_filter('post_type_link', function($postLink, $post){
    if (strpos($postLink, '%') === false) {
        return $postLink;
    }

    if (!preg_match_all('/\/%([^%]+)%\//U', $postLink, $matches)) {
        return $postLink;
    }

    foreach ($matches[1] as $it => $taxonomy) {
        $token = $matches[0][$it];
        $change = '/';

        if ($terms = get_the_terms($post->ID, $taxonomy)) {
            foreach ($terms as $term) {
                if (is_object($term)) {
                    $change = '/' . $term->slug . '/';
                    break;
                }
            }
        }

        $postLink = str_replace($token, $change, $postLink);
    }

    return $postLink;
}, 10, 4);

/**
 *
 */
add_filter('comment_post_redirect', function($location) {
    if (($hashPosition = strpos($location, '#')) !== false) {
        $hash = substr($location, $hashPosition+1);
        $location = substr($location, 0, $hashPosition);

        $location = add_query_arg(
            [
                '_hash' => $hash
            ],
            $location
        );
    }

    return $location;
});

/**
 *
 */
add_action('save_post', function($post_id) {
    // If this is just a revision, don't do anything
    if ( wp_is_post_revision( $post_id ) ) {
        return;
    }

    // Make an invalidation call to Magento
    $salt = get_option( 'fishpig_salt' );

    if (!$salt) {
        $salt = wp_generate_password( 64, true, true );
        update_option( 'fishpig_salt', $salt );
    }

    $nonce_tick = ceil(time() / ( 86400 / 2 ));

    $action = 'invalidate_wordpress_post_' . $post_id;

    $nonce = substr( hash_hmac( 'sha256', $nonce_tick . '|fishpig|' . $action, $salt ), -12, 10 );

    $invalidationUrl = add_query_arg([
            '_fp_invalidate' => $nonce,
            '_time' => time(),
        ], 
        get_permalink($post_id)
    );

    // Send the HTTP request
    if (function_exists('curl_init')) {
        $ch = curl_init($invalidationUrl);

        curl_setopt_array($ch, [
            CURLOPT_URL => $invalidationUrl,
            CURLOPT_HEADER => false,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_SSL_VERIFYHOST => false,
            CURLOPT_CONNECTTIMEOUT => 10
        ]);

        curl_exec($ch);
        curl_close($ch);
    } else {
        wp_remote_get($invalidationUrl);
    }
});

/**
 *
 */
add_action(
    'rest_api_init',
    function() {
        // Version
        register_rest_route(
            'fishpig/v1', 
            '/theme-hash/', 
            [
                'methods' => 'GET',
                'callback' => function() {
                    return ['hash' => FISHPIG_THEME_HASH];
                },
            ]
        );
    }
);

/**
 *
 */
add_filter( 'gutenberg_use_widgets_block_editor', '__return_false' );
add_filter( 'use_widgets_block_editor',           '__return_false' );
add_filter('wp_fatal_error_handler_enabled',      '__return_false' );
add_filter('wp_calculate_image_srcset',           '__return_false');

/**
 *
 */
foreach (['related-products.php', 'content-blocks.php', 'local.php'] as $themeFile) {
    if (is_file(__DIR__ . '/' . $themeFile)) {
        include_once __DIR__ . '/' . $themeFile;
    }
}